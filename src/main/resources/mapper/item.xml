<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.my.shop.item.ItemRepository">

    <resultMap id="itemMap" type="com.my.shop.item.dto.ItemDto" autoMapping="true">
        <id property="id" column="id" />
        <association property="itemStock" javaType="com.my.shop.item.dto.ItemStockDto"
                     autoMapping="true" columnPrefix="s_" />
    </resultMap>


    <insert id="insertItem" parameterType="com.my.shop.item.dto.ItemDto" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO items
            (item_name, price1, price2, price3)
        VALUES
            (#{itemName}, #{price1}, #{price2}, #{price3})
    </insert>

    <insert id="insertItemStock" parameterType="com.my.shop.item.dto.ItemDto">
        INSERT INTO item_stock
        (item_id, item_name, current_cnt, last_updated)
        VALUES(#{id}, #{itemName}, 0, now())
    </insert>

    <select id="selectItemByName" parameterType="com.my.shop.item.dto.ItemDto" resultMap="itemMap">
        SELECT
            i.*,
            s.item_id s_item_id,
            s.item_name s_item_name,
            s.current_cnt s_current_cnt
        FROM
            items i
        LEFT JOIN item_stock s ON s.item_id = i.id
        WHERE
            i.item_name like CONCAT('%',#{itemName},'%')
    </select>

    <insert id="insertItemHistroy" parameterType="com.my.shop.item.dto.ItemHistoryListDto">
        INSERT INTO item_history
        (
            customer, date
            , item_idx, item_name, cnt,
            type, created_at)
        VALUES
        <foreach collection="itemInfoList" item="item" separator=",">
        (
            #{customer}, #{date},
            #{item.itemId}, #{item.itemName}, #{item.cnt},
            #{type}, now()
        )
        </foreach>
    </insert>

    <update id="addItemCnt" parameterType="com.my.shop.item.dto.ItemHistoryListDto">
        UPDATE item_stock
        SET current_cnt = current_cnt + #{cnt},
        last_updated = NOW()
        WHERE item_id = #{itemId}
    </update>

    <update id="subItemCnt" parameterType="com.my.shop.item.dto.ItemHistoryListDto">
        UPDATE item_stock
        SET current_cnt = current_cnt - #{cnt},
        last_updated = NOW()
        WHERE item_id = #{itemId}
    </update>


    <select id="selectItemHistory" resultType="java.util.HashMap">
        SELECT
            *
        FROM item_history
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND date between #{startDate} and #{endDate}
        </if>
        <if test="itemName != null and itemName != ''">
            AND item_name like concat('%',#{itemName},'%')
        </if>
        <if test="customer != null and customer != ''">
            AND customer like concat('%',#{customer},'%')
        </if>
        ORDER BY date desc
    </select>

    <select id="selectItemList" resultType="java.util.HashMap">
        SELECT
            i.*,
            s.*
        FROM items i
        LEFT JOIN item_stock s ON s.item_id = i.id
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND created_at between #{startDate} and #{endDate}
        </if>
        ORDER BY created_at desc
    </select>

</mapper>